name: Qodana
on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  qodana-scan:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      contents: write
      pull-requests: write
      checks: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: "Qodana Backend Scan"
        uses: JetBrains/qodana-action@v2025.2
        with:
          results-dir: ./qodana-report

      - name: Upload Qodana report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: qodana-report-pr-${{ github.event.pull_request.number }}
          path: ./qodana-report/

  deploy-report:
    runs-on: ubuntu-latest
    needs: qodana-scan
    if: github.event.action != 'closed'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Download Qodana report
        uses: actions/download-artifact@v4
        with:
          name: qodana-report-pr-${{ github.event.pull_request.number }}
          path: ./downloaded-report

      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages-content
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR directory and copy report
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          cd gh-pages-content
          mkdir -p "pr-${PR_NUMBER}"
          cp -r ../downloaded-report/report/* "pr-${PR_NUMBER}/"

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages-content
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Add Qodana report for PR #${{ github.event.pull_request.number }}"
          git push origin gh-pages

      - name: Comment PR with Qodana report link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const reportUrl = `https://${owner}.github.io/${repo}/pr-${prNumber}/`;
            
            const comment = `## ðŸ“Š Qodana Code Quality Report
            
            Your code quality report is ready! ðŸš€
            
            ðŸ”— **[View Qodana Report](${reportUrl})**
            
            This report will be updated automatically with new commits.`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: owner,
              repo: repo,
              body: comment
            });

  cleanup-merged-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove PR directory
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          rm -rf "pr-${PR_NUMBER}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Remove Qodana report for merged PR #${PR_NUMBER}"
          git push origin gh-pages
